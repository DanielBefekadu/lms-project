name: Build Push and Retain Docker Images

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Set version
        run: echo "VERSION=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: |
          docker build -t ${{ secrets.DOCKERHUB_USERNAME }}/lms-app:latest \
                       -t ${{ secrets.DOCKERHUB_USERNAME }}/lms-app:${{ env.VERSION }} .

      - name: Push latest
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/lms-app:latest

      - name: Push version
        run: docker push ${{ secrets.DOCKERHUB_USERNAME }}/lms-app:${{ env.VERSION }}

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get all tags
        run: |
          curl -s -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
            https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/lms-app/tags/?page_size=100 \
            | jq -r '.results[].name' > tags.txt

      - name: Delete old tags keep only 3 newest
        run: |
          # Filter out 'latest'
          grep -v '^latest$' tags.txt | sort -r > versioned_tags.txt

          # Get tags except the newest 3
          tail -n +4 versioned_tags.txt > delete_tags.txt || true

          while read tag; do
            echo "Deleting old tag: $tag"
            curl -X DELETE -u "${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_PASSWORD }}" \
              "https://hub.docker.com/v2/repositories/${{ secrets.DOCKERHUB_USERNAME }}/lms-app/tags/$tag/"
          done < delete_tags.txt

      - name: Logout
        run: docker logout
